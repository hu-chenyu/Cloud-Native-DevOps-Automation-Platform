pipeline {
    agent any
    triggers {
        GenericTrigger(
            genericVariables: [
                [key: 'alertname', value: '$.alerts[0].labels.alertname']
            ],
            causeString: 'è§¦å‘è‡ªæ„ˆ: ${alertname}',
            tokenCredentialId: 'auto-recovery-token-plain',
            printContributedVariables: true
        )
    }
    environment {
        REGISTRY = "crpi-uza247h4wtxt6urw.cn-shenzhen.personal.cr.aliyuncs.com"
        NAMESPACE = "devops-platform-plus"
        REPO_NAME = "ansible-role"
        IMAGE_NAME = "crpi-uza247h4wtxt6urw.cn-shenzhen.personal.cr.aliyuncs.com/devops-platform-plus/ansible-role:enhanced"
        CONTAINER_NAME = "myapp-chaos"
        PORT_MAPPING = "5000:5000 5001:5001"
        PROMETHEUS_URL = "http://120.76.42.201:9090"
        ALERTMANAGER_URL = "http://120.76.42.201:9093"
    }
    parameters {
        booleanParam(
            name: 'AUTO_MODE',
            defaultValue: params.alertname ? true : false,
            // æ ¹æ®è§¦å‘æºè‡ªåŠ¨åˆ¤æ–­æ¨¡å¼
            description: 'æ˜¯å¦è‡ªåŠ¨åŒ–è§¦å‘'
        )
    }
    stages {
        stage('å®¹å™¨æ¢å¤') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'aliyun-acr', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASSWORD')]) {
                        sh '''#!/bin/bash -x
                            # æƒé™é¢„æ£€ï¼ˆå…³é”®è°ƒè¯•ä¿¡æ¯ï¼‰
                            echo "=== ç¯å¢ƒéªŒè¯ ==="
                            ls -l /var/run/docker.sock
                            groups
                            docker ps 2>&1
                            
                            # æ™ºèƒ½å®¹å™¨æ¢å¤
                            case "$(docker inspect -f '{{.State.Status}}' ${CONTAINER_NAME} 2>/dev/null || echo 'not_found')" in
                                "running")  
                                    echo "âœ… å®¹å™¨å·²åœ¨è¿è¡ŒçŠ¶æ€"
                                    ;;
                                "exited")   
                                    echo "ğŸ”„ æ£€æµ‹åˆ°åœæ­¢çš„å®¹å™¨ï¼Œæ­£åœ¨å¯åŠ¨..."
                                    docker start ${CONTAINER_NAME} || {
                                        echo "ğŸ› ï¸ å¯åŠ¨å¤±è´¥ï¼Œæ‰§è¡Œæ·±åº¦ä¿®å¤..."
                                        docker rm -f ${CONTAINER_NAME}
                                        docker run -d \\
                                            --name ${CONTAINER_NAME} \\
                                            -v /var/run/docker.sock:/var/run/docker.sock \\
                                            -p ${PORT_MAPPING} \\
                                            --restart=unless-stopped \\
                                            ${IMAGE_NAME}
                                    }
                                    ;;
                                "not_found")
                                    echo "ğŸ—ï¸ å®¹å™¨ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
                                    echo "$DOCKER_PASSWORD" | docker login \\
                                        --username "$ESCAPED_USER" \\
                                        --password-stdin "${REGISTRY}"
                                    docker run -d \\
                                        --name ${CONTAINER_NAME} \\
                                        -v /var/run/docker.sock:/var/run/docker.sock \\
                                        -p ${PORT_MAPPING} \\
                                        --restart=unless-stopped \\
                                        ${IMAGE_NAME}
                                    ;;
                                *)          
                                    echo "ğŸš¨ å¼‚å¸¸çŠ¶æ€: $container_status"
                                    exit 1
                                    ;;
                            esac
                            
                            # åŠ¨æ€å¥åº·æ£€æŸ¥
                            echo "ğŸ” å¼€å§‹å¥åº·æ£€æŸ¥..."
                            CONTAINER_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' ${CONTAINER_NAME})
                            for i in {1..10}; do
                                if curl -sSf --connect-timeout 3 http://${CONTAINER_IP}:5000/health; then
                                    echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
                                    break
                                else
                                    timeout=$(( (1 << i) * 2 ))  # 2,4,8...ç§’
                                    echo "â³ ç¬¬${i}æ¬¡æ£€æŸ¥å¤±è´¥ï¼ˆç­‰å¾…${timeout}ç§’ï¼‰..."
                                    sleep ${timeout}
                                fi
                                [ $i -eq 10 ] && { echo "âŒ å¥åº·æ£€æŸ¥è¶…æ—¶"; exit 1; }
                            done
                        '''
                    }
                }
            }
        }
        
        stage('å‘Šè­¦çŠ¶æ€åŒæ­¥') {
            when { expression { params.AUTO_MODE } }
            steps {
                script {
                    sh '''
                        #!/bin/bash
                        # åˆ é™¤å†å²å‘Šè­¦ç—•è¿¹
                        curl -X POST -g "${PROMETHEUS_URL}/api/v1/admin/tsdb/delete_series" \\
                            -d 'match[]={alertname=~"ChaosContainerDown|AppHealthCheckFailed"}'

                        # åˆ›å»ºç²¾å‡†é™é»˜è§„åˆ™ï¼ˆæœ‰æ•ˆæœŸ4å°æ—¶ï¼‰
                        startsAt=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
                        endsAt=$(date -u -d "+4 hours" +"%Y-%m-%dT%H:%M:%SZ")
                        
                        curl -X POST "${ALERTMANAGER_URL}/api/v2/silences" \\
                            -H "Content-Type: application/json" \\
                            -d "{
                                \\"matchers\\": [
                                    {\\"name\\":\\"alertname\\",\\"value\\":\\"AppHealthCheckFailed\\",\\"isRegex\\":false},
                                    {\\"name\\":\\"instance\\",\\"value\\":\\"http://myapp-chaos:5000/health\\",\\"isRegex\\":false}
                                ],
                                \\"startsAt\\":\\"${startsAt}\\",
                                \\"endsAt\\":\\"${endsAt}\\",
                                \\"createdBy\\":\\"auto-recovery-system\\",
                                \\"comment\\":\\"[è‡ªåŠ¨åŒ–] æ•…éšœä¿®å¤é™é»˜è§„åˆ™\\"
                            }"

                        # å¼ºåˆ¶æ•°æ®åˆ·æ–°
                        curl -X POST "${PROMETHEUS_URL}/-/reload"
                        echo "â³ ç­‰å¾…PrometheusæŒ‡æ ‡åˆ·æ–°"
                        sleep 60
                    '''
                }
            }
        }
        
        stage('éªŒè¯é—­ç¯') {
            steps {
                script {
                    sh '''
                        #!/bin/bash
                        # åŒé‡éªŒè¯æœºåˆ¶
                        echo "ğŸ” é˜¶æ®µ1ï¼šéªŒè¯å®¹å™¨çŠ¶æ€"
                        container_status=$(docker inspect -f '{{.State.Status}}' ${CONTAINER_NAME} 2>/dev/null || echo 'not_found')
                        [ "$container_status" != "running" ] && {
                            echo "âŒ å®¹å™¨çŠ¶æ€å¼‚å¸¸: $container_status"
                            exit 1
                        }

                        echo "ğŸ” é˜¶æ®µ2ï¼šéªŒè¯å‘Šè­¦çŠ¶æ€"
                        for i in {1..12}; do  # æœ€é•¿ç­‰å¾…12åˆ†é’Ÿ
                            alerts=$(curl -s "${PROMETHEUS_URL}/api/v1/alerts" | \\
                                jq -r '.data.alerts[] | select(.labels.alertname=="AppHealthCheckFailed" and .state=="firing")')
                            
                            if [ -n "$alerts" ]; then
                                echo "â³ å‘Šè­¦ä»å­˜åœ¨ï¼ˆç­‰å¾…60ç§’ï¼‰..."
                                sleep 60
                            else
                                echo "âœ… æ‰€æœ‰å‘Šè­¦å·²æ¸…é™¤"
                                exit 0
                            fi
                        done
                        echo "âŒ å‘Šè­¦æ¸…é™¤è¶…æ—¶"
                        exit 1
                    '''
                }
            }
        }
    }
    post {
        always {
            script {
                echo "===== ğŸ“Š æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š ====="
                sh '''
                    echo "ğŸ•’ æ—¶é—´æˆ³: $(date)"
                    echo "ğŸ³ å®¹å™¨çŠ¶æ€: $(docker inspect -f '{{.State.Status}}' ${CONTAINER_NAME} 2>/dev/null || echo 'not_found')"
                    echo "ğŸ“¡ Prometheusç›®æ ‡çŠ¶æ€:"
                    curl -s "${PROMETHEUS_URL}/api/v1/targets" | jq '.data.activeTargets[] | "\\(.labels.job): \\(.health)"'
                '''
            }
        }
        failure {
            script {
                echo "===== ğŸ”¥ æ•…éšœè¯Šæ–­ ====="
                sh '''
                    echo "ğŸ” å®¹å™¨æ—¥å¿—æœ€å50è¡Œ:"
                    docker logs ${CONTAINER_NAME} --tail 50 2>&1 || true
                    
                    echo "ğŸ“Š Prometheuså‘Šè­¦åˆ—è¡¨:"
                    curl -s "${PROMETHEUS_URL}/api/v1/alerts" | jq '.data.alerts[] | "\\(.labels.alertname): \\(.state)"'
                '''
            }
        }
    }
}
